# Руководство по миграции userId: Number → String

Это руководство описывает процесс миграции `userId` с типа `Number` на `String` для поддержки больших ID (> 2^53).

## Обзор изменений

### 1. Изменения в схемах
- Все поля `userId` изменены с `number` на `string`
- Добавлен уникальный индекс для идемпотентности: `{ userId: 1, taskRef: 1, clientAttemptId: 1 }`
- Добавлен индекс для денормализованного `moduleRef`: `{ userId: 1, moduleRef: 1, status: 1 }`

### 2. Изменения в API
- Все endpoints теперь принимают `userId` как строку
- Добавлен обязательный заголовок `Idempotency-Key` для POST `/progress/attempts`
- Обновлена логика создания прогресса с денормализацией `moduleRef`

### 3. Изменения в сервисах
- Все методы работают с `userId` как строкой
- Реализована идемпотентность для попыток
- Добавлена денормализация `moduleRef` при создании прогресса

## План миграции

### День 1: Подготовка (без даунтайма)

1. **Деплой кода на staging**
   ```bash
   npm run build
   # Деплой на staging
   ```

2. **Включение dual-write**
   - Код уже настроен на запись `userId` как строки
   - Все новые записи будут использовать строковый формат

3. **Тестирование на staging**
   ```bash
   npm run test:regression
   ```

### День 2: Миграция в продакшене

1. **Подготовка к миграции**
   ```bash
   # Создание бэкапа БД
   mongodump --uri="mongodb://localhost:27017/burlive" --out=./backup-$(date +%Y%m%d)
   ```

2. **Выполнение миграции userId**
   ```bash
   # Сначала dry run
   npm run migrate:userid:dry
   
   # Если все ОК, выполняем реальную миграцию
   npm run migrate:userid
   ```

3. **Денормализация moduleRef**
   ```bash
   # Сначала dry run
   npm run migrate:module-ref:dry
   
   # Если все ОК, выполняем реальную миграцию
   npm run migrate:module-ref
   ```

4. **Проверка результатов**
   ```bash
   npm run test:regression
   ```

### День 3: Включение идемпотентности

1. **Обновление клиента**
   - Добавить заголовок `Idempotency-Key` во все POST запросы к `/progress/attempts`
   - Использовать UUID для генерации ключей идемпотентности

2. **Мониторинг**
   - Отслеживать количество ошибок E11000 (дублирующие ключи)
   - Мониторить производительность API

## Скрипты миграции

### migrate-userid-to-string.ts
Преобразует все `userId` из `Number` в `String` во всех коллекциях:

```bash
# Dry run (проверка без изменений)
DRY_RUN=true npm run migrate:userid

# Реальная миграция
npm run migrate:userid
```

**Что делает:**
- Находит все документы с `userId` типа `int`
- Преобразует их в строки с помощью `$toString`
- Пересоздает все индексы с правильными типами
- Показывает статистику изменений

### denormalize-module-ref.ts
Добавляет поле `moduleRef` в коллекцию `user_lesson_progress`:

```bash
# Dry run
DRY_RUN=true npm run migrate:module-ref

# Реальная денормализация
npm run migrate:module-ref
```

**Что делает:**
- Находит документы без поля `moduleRef`
- Вычисляет `moduleRef` из `lessonRef` (первые 2 части)
- Создает индекс для быстрого поиска по модулям

### test-regression.ts
Проверяет корректность миграции:

```bash
npm run test:regression
```

**Что проверяет:**
- Все `userId` имеют тип `string`
- Большие `userId` (> 2^53) работают корректно
- Идемпотентность попыток работает
- Денормализованный `moduleRef` корректен
- API endpoints отвечают без ошибок

## Откат изменений

В случае проблем можно откатить изменения:

1. **Откат кода**
   ```bash
   git revert <commit-hash>
   npm run build
   # Деплой предыдущей версии
   ```

2. **Откат данных (если необходимо)**
   ```bash
   # Восстановление из бэкапа
   mongorestore --uri="mongodb://localhost:27017/burlive" ./backup-YYYYMMDD
   ```

## Мониторинг

После миграции отслеживайте:

1. **Производительность**
   - Время ответа API endpoints
   - Использование индексов в MongoDB

2. **Ошибки**
   - Количество ошибок E11000 (дублирующие ключи)
   - Ошибки валидации типов

3. **Данные**
   - Корректность `userId` как строк
   - Наличие `moduleRef` во всех документах прогресса

## Часто задаваемые вопросы

### Q: Что произойдет с существующими данными?
A: Все существующие `userId` будут преобразованы в строки. Функциональность останется прежней.

### Q: Нужно ли обновлять клиентское приложение?
A: Да, клиент должен отправлять заголовок `Idempotency-Key` для POST запросов к `/progress/attempts`.

### Q: Можно ли выполнить миграцию без даунтайма?
A: Да, код поддерживает dual-write, поэтому миграция может быть выполнена без остановки сервиса.

### Q: Что делать, если миграция прервалась?
A: Скрипты идемпотентны и могут быть запущены повторно. Проверьте логи и выполните тесты регресса.

## Контакты

При возникновении проблем обращайтесь к команде разработки.
